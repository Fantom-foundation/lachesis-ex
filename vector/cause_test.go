package vector

import (
	"fmt"
	"strconv"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/Fantom-foundation/lachesis-ex/hash"
	"github.com/Fantom-foundation/lachesis-ex/inter"
	"github.com/Fantom-foundation/lachesis-ex/inter/idx"
	"github.com/Fantom-foundation/lachesis-ex/inter/pos"
	"github.com/Fantom-foundation/lachesis-ex/kvdb/memorydb"
	"github.com/Fantom-foundation/lachesis-ex/logger"
)

func BenchmarkIndex_Cause(b *testing.B) {
	for i := 0; i < b.N; i++ {
		b.StopTimer()
		benchCauseMain(b, &i)
	}
}

func benchCauseMain(b *testing.B, idx *int) {
	benchCauseProcess(b, `
a0_1(3)  b0_1     c0_1     d0_1     e0_1     f0_1     g0_1     h0_1     i0_1     j0_1     k0_1     l0_1     m0_1     p0_1     q0_1
║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║
╠─────── b1_2     ║        ╠─────── e1_2     ║        ╠─────── h1_2     ║        ║        ║        ╠─────── m1_2     ║        ║
║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║
║        ╠─────── c1_3     ║        ╠─────── f1_3     ║        ║        ╠─────── j1_3     ╠─────── l1_3     ╠─────── p1_3     ║
║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║
║        ║        ╠─────── d1_4     ║        ╠─────── g1_4     ╠─────── i1_4     ╠─────── k1_4     ║        ║        ╠─────── q1_4
║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║        ║
`, idx)
}

func benchCauseProcess(b *testing.B, dag string, idx *int) {
	logger.SetTestMode(b)

	nodes, _, _ := inter.ASCIIschemeToDAG(dag)
	validators := pos.EqualStakeValidators(nodes, 1)

	events := make(map[hash.Event]*inter.EventHeaderData)
	getEvent := func(id hash.Event) *inter.EventHeaderData {
		return events[id]
	}

	vi := NewIndex(DefaultIndexConfig(), validators, memorydb.New(), getEvent)

	_, _, named := inter.ASCIIschemeForEach(dag, inter.ForEachEvent{
		Process: func(e *inter.Event, name string) {
			events[e.Hash()] = &e.EventHeaderData
			vi.Add(&e.EventHeaderData)
			vi.Flush()
		},
	})

	// check
	b.StartTimer()
	for _, ev := range named {
		for _, by := range named {
			who := by.Hash()
			whom := ev.Hash()
			vi.Cause(who, whom)
			if *idx > b.N {
				b.StopTimer()
				return
			}
			*idx++
		}
	}
	b.StopTimer()
}

func TestCausedClassic(t *testing.T) {

	t.Run("step 3", func(t *testing.T) {
		testCaused(t, `
a0_1(3)  b0_1     c0_1
║        ║        ║
╠─────── b1_2     ║
║        ║        ║
║        ╠─────── c1_3
║        ║        ║
`)
	})

	t.Run("step 4", func(t *testing.T) {
		testCaused(t, `
a0_1(3)  b0_1     c0_1
║        ║        ║
╠─────── b1_2     ║
║        ║        ║
║        ╠─────── c1_3
║        ║        ║
║        b2_4 ────╣
║        ║        ║
`)
	})

	t.Run("step 5", func(t *testing.T) {
		testCaused(t, `
a0_1(3)  b0_1(5)  c0_1(5)
║        ║        ║
╠─────── b1_2(5)  ║
║        ║        ║
║        ╠─────── c1_3(5)
║        ║        ║
║        b2_4 ────╣
║        ║        ║
a1_5 ────╣        ║
║        ║        ║
`)
	})

}

// testCaused uses event name agreement:
//  "<name>_<level>[(by-level)]",
// where by-level means that event is seen by all event with level >= by-level.
func testCaused(t *testing.T, dag string) {
	logger.SetTestMode(t)
	assertar := assert.New(t)

	nodes, _, _ := inter.ASCIIschemeToDAG(dag)
	validators := pos.EqualStakeValidators(nodes, 1)

	events := make(map[hash.Event]*inter.EventHeaderData)
	getEvent := func(id hash.Event) *inter.EventHeaderData {
		return events[id]
	}

	vi := NewIndex(DefaultIndexConfig(), validators, memorydb.New(), getEvent)

	_, _, named := inter.ASCIIschemeForEach(dag, inter.ForEachEvent{
		Process: func(e *inter.Event, name string) {
			events[e.Hash()] = &e.EventHeaderData
			vi.Add(&e.EventHeaderData)
			vi.Flush()
		},
	})

	// check
	for dsc, ev := range named {
		_, bylevel := decode(dsc)
		for dsc, by := range named {
			level, _ := decode(dsc)

			who := by.Hash()
			whom := ev.Hash()
			if !assertar.Equal(
				bylevel > 0 && bylevel <= level,
				vi.Cause(who, whom),
				fmt.Sprintf("%s sees %s", who.String(), whom.String()),
			) {
				return
			}
		}
	}
}

func decode(dsc string) (level, bylevel int64) {
	var err error

	s := strings.Split(dsc, "_")
	s = strings.Split(s[1], "(")

	level, err = strconv.ParseInt(s[0], 10, 32)
	if err != nil {
		panic(err)
	}

	if len(s) < 2 {
		return
	}

	bylevel, err = strconv.ParseInt(strings.TrimRight(s[1], ")"), 10, 32)
	if err != nil {
		panic(err)
	}

	return
}

func TestCausedRandom(t *testing.T) {
	assertar := assert.New(t)

	dag := `
 a000    
 ║        ║       
 ╠═══════ b000    
 ║        ║        ║       
 ║        ║        c000    
 ║        ║        ║        ║       
 ╠═══════─╫─══════─╫─══════ d000    
 ║        ║        ║        ║       
 a001════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════ b001     ║        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c001     ║       
 ║        ║        ║        ║       
 ║        b002═════╣        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d001    
 ║        ║        ║        ║       
 a002════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a003═════╣        ║        ║       
 ║        ║        ║        ║       
 ╠═══════ b003     ║        ║       
 ║        ║        ║        ║       
 ║        ║        c002═════╣       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d002    
 ║        ║        ║        ║       
 ║        ║        c003═════╣       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d003    
 ║        ║        ║        ║       
 a004════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════ b004     ║        ║       
 ║        ║        ║        ║       
 ║        ║        c004═════╣       
 ║        ║        ║        ║       
 a005════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b005     ║        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c005     ║       
 ║        ║        ║        ║       
 a006════─╫─═══════╣        ║       
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d004    
 ║        ║        ║        ║       
 ║        ╠═══════─╫─══════ d005    
 ║        ║        ║        ║       
 ║        b006════─╫─═══════╣       
 ║        ║        ║        ║       
 a007═════╣        ║        ║       
 ║        ║        ║        ║       
 ║        ║        c006═════╣       
 ║        ║        ║        ║       
 ║        ╠═══════─╫─══════ d006    
 ║        ║        ║        ║       
 ║        b007════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        ║        c007═════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════─╫─══════ d007    
 ║        ║        ║        ║       
 a008════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        b008════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        ╠═══════ c008     ║       
 ║        ║        ║        ║       
 a009════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b009     ║        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d008    
 ║        ║        ║        ║       
 ║        ║        c009═════╣       
 ║        ║        ║        ║       
 ║        b010═════╣        ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d009    
 ║        ║        ║        ║       
 a010════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c010     ║       
 ║        ║        ║        ║       
 ║        b011═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c011     ║       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d010    
 ║        ║        ║        ║       
 a011════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a012════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ╠═══════ b012     ║        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c012     ║       
 ║        ║        ║        ║       
 ║        b013═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c013     ║       
 ║        ║3       ║        ║       
 ║        ║╚══════─╫─══════ d011    
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d012    
 ║        ║        ║        ║       
 a013════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 a014═════╣        ║        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c014     ║       
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d013    
 ║        ║        ║        ║       
 ║        b014════─╫─═══════╣       
 ║        ║        ║        ║       
 a015═════╣        ║        ║       
 ║        ║        ║        ║       
 ║        b015═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c015     ║       
 ║        ║        ║        ║       
 a016════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ║        b016═════╣        ║       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c016     ║       
 ║        ║        ║        ║       
 a017════─╫─═══════╣        ║       
 ║        ║        ║        ║       
 ║        b017═════╣        ║       
 ║        ║        ║        ║       
 a018═════╣        ║        ║       
 ║5       ║        ║        ║       
 ║╚══════─╫─══════─╫─══════ d014    
 ║        ║        ║║       ║       
 ║        ║        ║╚══════ d015    
 ║3       ║        ║        ║       
 ║╚══════─╫─══════─╫─══════ d016    
 ║        ║        ║        ║       
 ║        ║        c017═════╣       
 ║        ║        ║        ║       
 ║        b018═════╣        ║       
 ║        ║        ║        ║       
 ║        ╠═══════ c018     ║       
 ║        ║║       ║        ║       
 ║        ║╚══════─╫─══════ d017    
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d018    
 ║        ║        ║        ║       
 a019════─╫─══════─╫─═══════╣       
 ║        ║        ║        ║       
 ║        b019════─╫─═══════╣       
 ║        ║        ║        ║       
 ╠═══════─╫─══════ c019     ║       
 ║        ║        ║        ║       
 ║        ║        ╠═══════ d019    
`
	relations := map[string]map[string]struct{}{
		"a000": map[string]struct{}{},
		"a001": map[string]struct{}{},
		"a002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"a003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"a004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}},
		"a005": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"a006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"a007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"a008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"a009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"a010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"a011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"a012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"a013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"a014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"a015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"a019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"b000": map[string]struct{}{},
		"b001": map[string]struct{}{"a000": {}, "d000": {}},
		"b002": map[string]struct{}{"a000": {}, "a001": {}, "d000": {}},
		"b003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}, "d001": {}},
		"b004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b005": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"b008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"b009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"b010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"b011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"b012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"b015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}},
		"b016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"b017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"b018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"b019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"c000": map[string]struct{}{},
		"c001": map[string]struct{}{"a000": {}, "a001": {}, "d000": {}},
		"c002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "d000": {}},
		"c003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"c004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"c005": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"c006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"c007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"c008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"c009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"c010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"c011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"c012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"c013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"c014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}},
		"c015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"c018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"c019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}, "d017": {}, "d018": {}},
		"d000": map[string]struct{}{},
		"d001": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "d000": {}},
		"d002": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "c000": {}, "c001": {}, "d000": {}},
		"d003": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"d004": map[string]struct{}{"a000": {}, "a001": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "d000": {}},
		"d005": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"d006": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}},
		"d007": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}},
		"d008": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"d009": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}},
		"d010": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}},
		"d011": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}},
		"d012": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d013": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d014": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}},
		"d015": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d016": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d017": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}},
		"d018": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}},
		"d019": map[string]struct{}{"a000": {}, "a001": {}, "a002": {}, "a003": {}, "a004": {}, "a005": {}, "a006": {}, "a007": {}, "a008": {}, "a009": {}, "a010": {}, "a011": {}, "a012": {}, "a013": {}, "a014": {}, "a015": {}, "a016": {}, "a017": {}, "a018": {}, "a019": {}, "b000": {}, "b001": {}, "b002": {}, "b003": {}, "b004": {}, "b005": {}, "b006": {}, "b007": {}, "b008": {}, "b009": {}, "b010": {}, "b011": {}, "b012": {}, "b013": {}, "b014": {}, "b015": {}, "b016": {}, "b017": {}, "b018": {}, "c000": {}, "c001": {}, "c002": {}, "c003": {}, "c004": {}, "c005": {}, "c006": {}, "c007": {}, "c008": {}, "c009": {}, "c010": {}, "c011": {}, "c012": {}, "c013": {}, "c014": {}, "c015": {}, "c016": {}, "c017": {}, "c018": {}, "d000": {}, "d001": {}, "d002": {}, "d003": {}, "d004": {}, "d005": {}, "d006": {}, "d007": {}, "d008": {}, "d009": {}, "d010": {}, "d011": {}, "d012": {}, "d013": {}, "d014": {}, "d015": {}, "d016": {}, "d017": {}, "d018": {}},
	}

	ordered := make([]*inter.Event, 0)
	nodes, _, named := inter.ASCIIschemeForEach(dag, inter.ForEachEvent{
		Process: func(e *inter.Event, name string) {
			ordered = append(ordered, e)
		},
	})

	validators := pos.EqualStakeValidators(nodes, 1)

	events := make(map[hash.Event]*inter.EventHeaderData)
	getEvent := func(id hash.Event) *inter.EventHeaderData {
		return events[id]
	}

	vi := NewIndex(DefaultIndexConfig(), validators, memorydb.New(), getEvent)

	// push
	for _, e := range ordered {
		events[e.Hash()] = &e.EventHeaderData
		vi.Add(&e.EventHeaderData)
		vi.Flush()
	}

	// check
	for e1name, e1 := range named {
		for e2name, e2 := range named {
			_, expect := relations[e1name][e2name]
			if !assertar.Equal(
				expect,
				vi.Cause(e1.Hash(), e2.Hash()),
				fmt.Sprintf("%s sees %s", e1.Hash(), e2.Hash()),
			) {
				return
			}
		}
	}
}

type eventSlot struct {
	seq     idx.Event
	creator idx.StakerID
}

// naiveHighestBefore is naive implementation of highest before vector, O(n)
func naiveHighestBefore(vi *Index, head *inter.EventHeaderData) (hb HighestBeforeSeq, err error) {
	hb = NewHighestBeforeSeq(vi.validators.Len())
	visited := hash.EventsSet{}
	detected := map[eventSlot]int{}
	onWalk := func(id hash.Event) (godeeper bool) {
		// ensure visited once
		if visited.Contains(id) {
			return false
		}
		visited.Add(id)

		e := vi.getEvent(id)
		slot := eventSlot{
			seq:     e.Seq,
			creator: e.Creator,
		}
		detected[slot]++
		return true
	}
	onWalk(head.Hash())
	err = vi.dfsSubgraph(head, onWalk)
	for s, count := range detected {
		stakerIdx := vi.validators.GetIdx(s.creator)
		current := hb.Get(stakerIdx)
		if count > 1 {
			panic("fork detected")
		}
		if current.Seq < s.seq {
			current.Seq = s.seq
		}
		if current.MinSeq > s.seq || current.MinSeq == 0 {
			current.MinSeq = s.seq
		}
		hb.Set(stakerIdx, current)
	}
	return hb, err
}

// naiveCause is naive implementation of Cause, O(n)
func naiveCause(vi *Index, a, b *inter.EventHeaderData) bool {
	bCreatorIdx := vi.validators.GetIdx(b.Creator)
	hb := vi.GetHighestBeforeMerged(a.Hash())

	// calculate highestVisitedHash
	visited := hash.EventsSet{}
	highestVisitedSeq := map[idx.Validator]idx.Event{}
	highestVisitedHash := map[idx.Validator]hash.Event{}
	onWalk := func(id hash.Event) (godeeper bool) {
		// ensure visited once
		if visited.Contains(id) {
			return false
		}
		visited.Add(id)

		e := vi.getEvent(id)
		creatorIdx := vi.validators.GetIdx(e.Creator)
		if highestVisitedSeq[creatorIdx] == e.Seq {
			panic("Visited by a different event with the same seq, but fork still isn't observed")
		}
		if highestVisitedSeq[creatorIdx] < e.Seq {
			highestVisitedSeq[creatorIdx] = e.Seq
			highestVisitedHash[creatorIdx] = e.Hash()
		}
		return true
	}
	onWalk(a.Hash())
	_ = vi.dfsSubgraph(a, onWalk)

	if !visited.Contains(b.Hash()) {
		return false
	}

	hbs := make([]HighestBeforeSeq, vi.validators.Len())
	for creatorIdx := idx.Validator(0); creatorIdx < idx.Validator(vi.validators.Len()); creatorIdx++ {
		hbs[creatorIdx] = vi.GetHighestBeforeMerged(highestVisitedHash[creatorIdx])
		if hb.Get(creatorIdx).Seq != highestVisitedSeq[creatorIdx] {
			panic("highestVisitedSeq and HighestBefore aren't consistent")
		}
	}

	counter := pos.Stake(0)
	for creatorIdx := idx.Validator(0); creatorIdx < idx.Validator(vi.validators.Len()); creatorIdx++ {
		if hbs[creatorIdx] == nil {
			continue
		}
		if hbs[creatorIdx].Get(bCreatorIdx).Seq >= b.Seq {
			counter += vi.validators.GetStakeByIdx(creatorIdx)
		}
	}
	if counter > vi.validators.TotalStake() {
		panic("Counted more than once")
	}

	return counter >= vi.validators.Quorum()
}
